---
title: "Consumer Resource Model - description"
author: "Daniel Garza"
date: "1/19/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## simulateConsumerResource

Function to simulate MacArthur's consumer-resource model and its extensions for microbiomes. The model describe the dynamics of microbes and substrates in a community where the ecological interactions are explicitly encoded via the consumption and production of metabolites.

### **Model Description**

Each microbial species from a community of $n$ different species has preferences for a specific subset of the $k$ different substrates that are available to the community. Their growth rates depend on the availability of these resources, through the following differential equation:

$\frac{dX_i}{dt} = \mu_{i}X_i (\sum_{j=1}^{k} e_{i,j} f_{i,j} S_j - \delta_i)$

where, where $\mu_{i}$ is the maximum growth rate of species $i$, while $X_i$ is its abundance at time $t$.

$e_{i,j}$ is the yield of substrate $j$ for species $i$, $f_{i,j}$ is the feeding form, which constraints the quantity of the substrate that can be consumed at each time step, while $S_j$ is the concentration of the substrate $j$ at time $t$, and $\delta_i$ is a dilution term.

The form of the feeding term is the Monod equation $f_{i,j}=\frac{S_j}{k_{i,j}+S_j}$, where $k_{i,j}$ is the Monod constant.

Resources change according to the following differential equation:

$\frac{dS_j}{dt}=\phi_j - \sum_{i=1}^{n} e_{i,j}f_{i,j}X_i + \sum_{i=1}^{n}p_{i,j} X_{i} (\sum_{j=1}^{k}e_{i,j}f_{i,j}-\delta_i)$

where $\phi_j$ is a dilution term and $p_{i,j}$ is the yield of production of substrate $j$ that results from the growth of species $i$.

In practice, a species either consumes or produces a metabolite (or is indifferent to its presence). Allowing us to summarize $e_{i,j}$ and $p_{i,j}$ in a single matrix ($E$, containing $n$ rows and $k$ columns). To distinguish them, the entries of $E$ are, respectively, positive and negative for the consumed and produced substrates.

There are many possibilities for structuring $E$ according to specific assumptions. We will later summarize the options that are built into miaSim. But, first let's jump to some quick examples of how to simulate a consumer resource model with miaSim.

### **Examples**

All examples below are compatible with the Shiny app. Feel free to click on the numbered example button on the top of the app screen to explore them.

If not provided by the user, all parameters have default values except for the the number of species and the number of resources, which need to be provided. Check the list of parameters below for a complete description of the parameters and their defaults.

#### **Example1: Default parameters**

To illustrate the basic parameters, we begin simulating five species consuming or producing five different substrates.

```{r}

n.species <- 5
n.resources <- 5

#simulate the model 

CRMsimul <- simulateConsumerResource(n.species = n.species, n.resources = n.resources)

#visualize the result 

makePlot(CRMsimul$matrix) #species plot
makePlotRes(CRMsimul$resources) #resources plot

```

#### **Example2: exploring additional parameters**

MiaSim provides a helper function to generate the matrix $E$.

Below is a simulation of the same model where the user has more control over the parameters.

```{r}

#generate the matrix E
E = randomE(n.species = n.species, n.resources = n.resources)
print(E)

#positive entries are consumed, negative produced, zero has no influence on the species

#define some simulation parameters
t.end = 2000 #when to stop
t.store = 500 #how many samples of the simulation to store (evenly spaced)
migration.p = 0 #whether to allow migration from a metacommunity
stochastic = 0 # whether to use noise in the simulation
dilution.rate = 0.001 #adding a dilution rate

#simulate the model
CRMsimul <- simulateConsumerResource(n.species = n.species, n.resources = n.resources, stochastic = stochastic, migration.p = migration.p, E=E, t.end = t.end, t.store = t.store, dilution.rate=dilution.rate)

#visualize the result
makePlot(CRMsimul$matrix) #species plot
makePlotRes(CRMsimul$resources) #resources plot

```

#### More about the $E$ matrix

The $E$ matrix contains the energy yield for the production of biomass and the secretion of metabolic by-products. In practice, there are alternative formulations to define the flux between substrate consumption and production.

When generating the random $E$ matrix using the function `randomE` there is a parameter called `maintenance` where the user may constraint the fraction of the flux that is not returned as a byproduct. This parameter can be interpreted as a fraction of the fluxes that are channeled into the organism's maintenance.

#### **Example 3: maintenance**

```{r}

E = randomE(n.species = 1, n.resources = 10, maintenance = .1)

print(sum(E*(E>0))) #consumed. For simplicity, values are normalized to add to 1

print(abs(sum(E*(E<0)))) #produced

```

#### Using stoichiometric relatioships for the secretion of metabolic by-products

MiaSim is flexible for other relationships between the consumption of growth compounds and the secretion of byproducts since the user may provide their own $E$ matrix to the `simulateConsumerResource` function.

One approach is to tie the consumption and production of resources to the stoichiometry of biological reactions (see [Marsland III, et al. 2019](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1006793)) .

#### **Example 4: anaerobic food web**

For instance, consider a community consisting of three microbes:

-   One that converts 1 mol of glucose to 3 mols of acetate with a yield of 4.3 mols of ATP, that we'll label as an "homoacetogen".

-   One that converts 1 mol of glucose into 2 mols of lactate, with a yield of two mols of ATP, that we'll label "homofermenter";

-   One that converts 4 mols of lactate and into 3 mols of butyrate, with a yield of 1 ATP, that we'll name "butyrateProducer".

```{r}
#The stoichiometric matrix 
D = matrix(c(1, -3, 0, 0, 1, 0, -2, 0, 0, 0, 4, -3), nrow = 3, byrow = TRUE)
yields = c(4.3/4, 2/4, 1/4)
E = D*yields

#growth rates
grs <- c(2, 4.5, 2.6)

#initial species composition
x0 <- c(1, 2, 1)

#initial media composition
resources <- c(10, 0, 0, 0)

#simulate the model
CRMsimul <- simulateConsumerResource(n.species = 3, n.resources = 4, stochastic = 0, migration.p = 0.0, E=E,dilution.rate=0.005,resources = resources, names.species = c('homoacetogenic', 'homofermentative', 'butyrateProducer'), names.resources = c('glucose', 'acetate', 'lactate', 'butyrate'), x0=x0, t.end = 10000, growth.rates = grs)

#visualize the result
makePlot(CRMsimul$matrix) #species plot
makePlot(CRMsimul$resources) #resources plot
```

#### **Example 5: Preferred substrates**

In general, substrates are not equally preferred by the microbes in a community, miaSim provides the possibility of generating the random $E$ matrix with a bias towards some preferred resource. This leads to the enrichment of the microbial preferences towards more "valuable" resources. This can be done by specifying the `trophic.preferences` parameter in the `randomE` function:

```{r}

E = randomE(n.species = 10, n.resources = 10, mean.consumption = 3, mean.production = 1, maintenance = 0.5, trophic.preferences = list(c(5, 3, 1, 1, 1, 1, 1, 1, 1, 1)))

#visualize the matrix
makeHeatmap(E)

```

#### **Example 6: hierarchical trophic preferences**

In a complex community, feeding might be structured in a hierarchical way through trophic groups. Each group would prefer certain substrates and secrete by-products that are then preferred by the next subgroup. Evidence of such multilevel organization has been shown for the human gut microbiome ([Wong et al. 2019](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1007524)).

The parameter `trophic.levels` or the `randomE` function allows users to simulate communities with multiple levels of substrate preferences, that cross-feed to each other in hierarchical fashion.

```{r}
E = randomE(n.species = 20, n.resources = 20, mean.consumption = 3, mean.production = 2, maintenance = 0.0, trophic.levels = c(7, 13))

#visualize the matrix
makeHeatmap(E)

#visualize the sum of trophic preferences by level
Ep1 <- E[0:7,]
Ep2 <- E[7:20,]

levels<- t(cbind(colSums(Ep1*(Ep1<0)), colSums(Ep2*(Ep2>0))))

makeHeatmap(levels)

```

#### **Example 7: Nested tropic levels**

The default implementation of MiaSim supports only the definition of linear levels.

One can easily add nested relationships using the `trophic.preferences` parameter. For instance, consider the interactions depicted in the following cartoon where arrows represent the direction of the secretion/consumption flux of metabolic by-products between species.

![interaction cartoon](https://raw.githubusercontent.com/danielriosgarza/microbialTimeSeries/reviewed/files/images/interactionCartoon.png "interaction cartoon"){width="600"}

To simulate a model with similar topology. We begin by setting the basic parameters:

```{r}
n.species = 4
n.resources = 11
names.species = c('A', 'B', 'C', 'D')

#initial species composition
x0 <- rep(1, 4)

#initial media composition
resources <- rep(1.5, 11)
```

Next, we go species-by-species and define their trophic preferences according to the cartoon, but making some use of the stochastic choices from the `randomE` function.

we start drawing three secretion products for species C from a Dirichlet distribution, making sure it adds to $.5.$ These will be the first three metabolites from the eleven that are present in the community. We use these to make the preferences of species A and D, and use the `random.E` function to draw their secretion products.

```{r}
#secretion of C
sec.C <- rdirichlet(1, c(1,1,1))*.5

#The metabolic preferences of A are set to the secretion products of C
pref.A.D <- list(c(sec.C*1000, rep(1,8)))

em.A <- randomE(n.species = 1, n.resources = 11, names.species = 'A', trophic.preferences = pref.A.D, mean.production = 3, mean.consumption = 3)

#secretion of A
sec.A <- abs(em.A*(em.A<0))

#The metabolic preferences of D are set to the secretion products of A
em.D <- randomE(n.species = 1, n.resources = 11, names.species = 'D', trophic.preferences = pref.A.D, mean.production = 3, mean.consumption = 3)

#secretion of D
sec.D <- abs(em.D*(em.D<0))

```

Now we can use the byproducts of A and D as the preferred nutrients for B and use its byproducts as the preferred nutrients of C. For this, we need to assure that the three first metabolites are not byproducts of B so that it does not contradict the secretion of C when given as its preferred nutrients.

```{r}

#The metabolic preferences of B are set to the secretion products of A and D
pref.B <- 1000*((sec.A + sec.D)/(sum(sec.A)+sum(sec.D)))
pref.B[pref.B==0] <- 1
pref.B <- list(pref.B[4:11])

em.B <- randomE(n.species = 1, n.resources = 8, names.species = 'B', trophic.preferences = pref.B, mean.production = 3, mean.consumption = 3)

#secretion of B
sec.B <- abs(em.B*(em.B<0))

#The metabolic preferences of C are set to the secretion products B
pref.C <- sec.B*1000
pref.C[pref.C==0] <- 1

em.B <-t(as.matrix(c(rep(0,3),em.B)))
row.names(em.B) = 'B'

em.C <- randomE(n.species = 1, n.resources = 8, names.species = 'C', trophic.preferences = list(pref.C), mean.production = 0, mean.consumption = 3)

em.C <- cbind(-sec.C, em.C)

#Assembing the matrix
E <- rbind(em.A, em.B, em.C, em.D)

#visualize the matrix
makeHeatmap(E)

#simulate the model
CRMsimul <- simulateConsumerResource(n.species = n.species, n.resources = n.resources, stochastic = FALSE, migration.p = 0.0, E=E,dilution.rate=0, names.species = c('A', 'B', 'C', 'D'), resources = resources, x0 = x0)

#visualize the result
makePlot(CRMsimul$matrix) #species plot
makePlot(CRMsimul$resources) #resources plot
```

#### More advanced example

The models we have so far simulated in a single instance, generating one simulated time series. There might be occasions when one is interested in studying the outcome of multiple simulations. One example could be exploring if a set of parameters influence the diversity of the steady-state communities. Or studying if a different set of parameters are give rise to communities that are different enough fundamentally different separate ourm

#### Adding Noise and simulating measurement error

##### 

#### Exploring the relationship between diversity and environmental noise

## .
