---
title: "Hubbell model - description"
author: "Yu Gao"
date: "3/16/2022"
output: html_document
---

## simulateHubbellRates

Function to simulate Stephen P. Hubbell's neutral model for microbial communities (with an adjustable growth rate which can differ from species to species).

This model is neutral as assumed by Hubbell's definition: an ecological community (a group of trophically similar, sympatric species that actually or potentially compete in a local area for the same or similar resources) is structured entirely by ecological drift, random migration, and random speciation. The unified neutral theory of biodiversity (UNTB) treats organisms in the community as essentially identical in their per capita probabilities of giving birth, dying, migrating, and speciating. (*The unified neutral theory of biodiversity and biogeography*)

To accelerate the simulation, instead of drawing from a probability distribution function at each time point, we converted the probability to the equivalent waiting time interval using a gamma distribution. This is done with the same principal as in the Gillespie algorithm.

### **Model Description**

Initial abundances (numbers of individuals) of different microbial species is $x0$. For each species, $growth_rates$ are their average growth rates ($\frac{n_{t+\tau}}{n_t}$, with n indicating number of individuals) and $metacommunity_probability$ is their probabilities of migration from the metacommunity. If not given, $growth_rates$ will be identical to 1, and $metacommunity_probability$ will be drawn from a Dirichlet distribution. Need to mention that this is different from the original Hubbell's UNTB.

As mentioned before, there's a conversion from probability at each time point to the waiting time interval, and we define the number of events (birth and migration) during this time interval as $k.event$. In this implementation of the model, the total number of individuals is fixed, so the number of new birth or immigration of individuals sum up to the number of dead individuals during the same period. To be detailed, $migration_p$ defines the probability of a new species coming from the immigration, and $1-migration_p$ defines the probability of a new species coming from the birth. Here the probability is applied to all individuals and is demographically proportional to their corresponding populations of each species.

From $t_start$, the time interval $\tau$ is recalculated repeatedly as indicated by the following gamma distribution: $\tau = \Gamma(k.event, \frac{1}{\sum_{n=1}^{n_species} x0})$

Before the total time accumulated to the $t_end$, a series of calculation happen recursively in every different time interval:

1.  calculate random death:

    $death = Multi(k_events, relative \space abundance)$

2.  split $k_events$ to 2 parts:

    $k_{birth} = B(k_events, 1-migration_p)$ , and

    $k_{migration} = k_events - k_{birth}$

3.  calculate random birth of new individuals:

    $birth = Multi(k_{birth}, relative \space abundance)$

4.  calculate random migration of new individuals:

    $migration = Multi(k_{migration}, metacommunity_probability)$

5.  combine all random calculations:

    $n_{t+\tau} = n_{t} \times growth_rates - death + birth + migration$

### **Examples**

All examples below are compatible with the Shiny app. Feel free to click on the numbered example button on the top of the app screen to explore them.

If not provided by the user, all parameters have default values except for the the number of species, which needs to be provided in Shiny app. Check the list of parameters below for a complete description of the parameters and their defaults.

#### **Example1: Default parameters**

```{r}
set.seed(42)
ExampleHubbellRates <- simulateHubbellRates(n_species = 5)
makePlot(ExampleHubbellRates$matrix)
```

#### **Example2: no migration from metacommunity, all stochastic birth and death**

```{r}
set.seed(42)
ExampleHubbellRates <- simulateHubbellRates(n_species = 5, migration_p = 0)
makePlot(ExampleHubbellRates$matrix)
```

#### **Example3: all migration from metacommunity, no stochastic birth and death**

```{r}
set.seed(42)
ExampleHubbellRates <- simulateHubbellRates(
    n_species = 5, 
    migration_p = 1,
    metacommunity_probability = c(0.1, 0.15, 0.2, 0.25, 0.3),
    t_end = 20, 
    t_store = 200)
makePlot(ExampleHubbellRates$matrix)
```

#### **Example4: all migration, no stochastic birth and death, but with measurement errors**

```{r}
set.seed(42)
ExampleHubbellRates <- simulateHubbellRates(
    n_species = 5, 
    migration_p = 1,
    metacommunity_probability = c(0.1, 0.15, 0.2, 0.25, 0.3),
    t_end = 20, 
    t_store = 200,
    error_variance = 100)
makePlot(ExampleHubbellRates$matrix) 
```

#### **Example5: model with specified growth rates for different species and specified metacommunity probabilities**

```{r}
set.seed(42)
ExampleHubbellRates <- simulateHubbellRates(
    n_species = 5,
    migration_p = 0.1,
    metacommunity_probability = c(0.1, 0.15, 0.2, 0.25, 0.3), 
    t_end = 200, 
    t_store = 1000, 
    k_events = 5,
    growth_rates = c(1.1, 1.05, 1, 0.95, 0.9))
makePlot(ExampleHubbellRates$matrix)
```
